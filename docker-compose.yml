version: '3'
services:
  nginx:
    image: nginx
    ports:
      - "3000:80" # expose port 3000 on host and pass to port 80 of the nginx container
    volumes:
      - "${ros_dir:-.}/nginx.conf:/etc/nginx/conf.d/default.conf"
      - "${ros_dir:-.}/nginx-services.conf:/etc/nginx/conf.d/services/ros.conf"
    depends_on:
      - cognito
      - comm
      - iam
  wait:
    image: waisbrot/wait
    depends_on:
      - db
    environment:
      TARGETS: 'db:5432'
  db:
    image: mdillon/postgis:9.6
    ports:
      - "5432" # - "5432:5432"
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: postgres
  iam:
    image:
      "rails-on-services/ros-iam:${rails_env:-development}-${image_tag:-undefined}"
    build:
      context: "${ros_dir:-.}"
      args:
        bundle_string: "${bundle_string:---with=development test}"
        rails_env: "${rails_env:-development}"
        os_packages: "${os_packages:-libpq5 git sudo vim less tcpdump net-tools iputils-ping}"
        project: ros-iam
        PUID: "${puid:-1000}"
        PGID: "${pgid:-1000}"
    env_file:
      - ./app.env
      - ./docker-compose.env
    depends_on:
      - wait
    ports:
      - "3000"
    # command: ["tail", "-F", "log/development.log"] # don't start the server
  cognito:
    image:
      "rails-on-services/ros-cognito:${rails_env:-development}-${image_tag:-undefined}"
    build:
      context: "${ros_dir:-.}"
      args:
        bundle_string: "${bundle_string:---with=development test}"
        rails_env: "${rails_env:-development}"
        os_packages: "${os_packages:-libpq5 git sudo vim less tcpdump net-tools iputils-ping}"
        project: ros-cognito
        PUID: "${puid:-1000}"
        PGID: "${pgid:-1000}"
    env_file:
      - ./app.env
      - ./docker-compose.env
    depends_on:
      - wait
    ports:
      - "3000"
  comm:
    image:
      "rails-on-services/ros-comm:${rails_env:-development}-${image_tag:-undefined}"
    build:
      context: "${ros_dir:-.}"
      args:
        bundle_string: "${bundle_string:---with=development test}"
        rails_env: "${rails_env:-development}"
        os_packages: "${os_packages:-libpq5 git sudo vim less tcpdump net-tools iputils-ping}"
        project: ros-comm
        PUID: "${puid:-1000}"
        PGID: "${pgid:-1000}"
    env_file:
      - ./app.env
      - ./docker-compose.env
    depends_on:
      - wait
    ports:
      - "3000"
